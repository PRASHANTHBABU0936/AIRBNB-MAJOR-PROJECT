<% layout("layouts/boilerplate") -%>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
  .book-now-hover {
  transition: transform 0.2s ease-in-out;
  font-weight: 500;
}
.book-now-hover:hover {
  transform: scale(1.1);
  background-color: #c82333;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
}

  .booking-alert {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: bold;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease;
  }

  .book-now-hover {
    transition: transform 0.2s ease-in-out;
    font-weight: 500;
    height: 50px;
  }

  .book-now-hover:hover {
    transform: scale(1.1);
    background-color: #c82333;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  }
</style>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const coordinates = <%- JSON.stringify(listing.geometry?.coordinates || [77.2090, 28.6139]) %>;
</script>

<div class="row mt-3">
  <div class="col-8 offset-2">
    <h3><%= listing.title %></h3>
  </div>


  <div class="card col-6 offset-3 show-card listing-card">
    <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
    <div class="card-body">
<% if (listing.owner && listing.owner.username) { %>
<p class="card-text mb-3 fw-bold" style="font-size: 1.1rem; transform: scale(1.03);">
  Owned By: <i><%= listing.owner.username %></i>
</p>
<% } else { %>
  <p class="card-text text-danger mb-3">Owner unknown</p>
<% } %>

<!-- Booking form positioned to the right of the owner name block using flex container -->
<div class="d-flex justify-content-end mb-4">
  <form action="/listings/<%= listing._id %>/book" method="POST" class="d-flex align-items-center" style="gap: 10px;">
    <input type="date" name="date" required class="form-control form-control-sm" style="width: 160px;">
<button type="submit" class="btn btn-danger btn-sm book-now-hover fw-bold" style="transform: scale(1.05);">
  Book Now
</button>
  </form>
</div>

  </div>




      <br>
      <p class="card-text"><%= listing.description %></p><br>
      <p class="card-text">&#8377; <%= listing.price.toLocaleString("en-IN") %></p>
      <p class="card-text"><%= listing.location %></p>
      <p class="card-text"><%= listing.country %></p>
    </div>
  </div>

  <br>


<% if (booked === 'success' && bookedDate && currUser) { %>
  <script>
    Swal.fire({
      icon: 'success',
      title: 'Booking Confirmed!',
      text: `ðŸŽ‰ Mr. <%= currUser.username %>, you booked on <%= bookedDate %>`,
      confirmButtonText: 'Awesome!',
      timer: 4000,
      timerProgressBar: true
    });
  </script>
<% } else if (booked === 'exists') { %>
  <script>
    Swal.fire({
      icon: 'warning',
      title: 'Already Booked!',
      text: 'This date is already taken. Try another date.',
      confirmButtonText: 'Okay'
    });
  </script>
<% } %>


  <% if (bookedDate) { %>
    <div id="booking-msg" class="booking-alert">
      Successfully booked on <%= bookedDate %>!
    </div>
  <% } %>

  <div class="btns">
    <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark col-1 offset-3 edit-btn">Edit</a>
    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
      <button class="btn btn-dark offset-5">Delete</button>
    </form>
  </div>
<div class="col-8 offset-3 mb-3">

  <% if (currUser) { %>
    <hr/>
    <h4>Leave a Review</h4>
    <form action="/listings/<%= listing._id %>/reviews" method="POST">
      <div class="mb-3">
        <label for="rating" class="form-label">Rating</label>
        <select class="form-select" name="review[rating]" required>
          <option disabled selected>Select a rating</option>
          <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
          <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
          <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
          <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
          <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea class="form-control" name="review[comment]" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-success">Submit Review</button>
    </form>
  <% } else { %>
    <hr/>
    <p class="text-muted">Log in to leave a review.</p>
  <% } %>

  <h3 class="mt-4">Reviews</h3>
<% if (listing.reviews.length === 0) { %>
  <p class="text-muted">No reviews yet.</p>
<% } else { %>
  <% for (let review of listing.reviews) { %>
    <div class="card mb-2 p-2">
      <!-- Show stars -->
      <div class="text-warning">
        <% for (let i = 0; i < review.rating; i++) { %>
          â˜…
        <% } %>
        <% for (let i = review.rating; i < 5; i++) { %>
          â˜†
        <% } %>
      </div>

      <!-- Comment and username -->
      <p><%= review.comment %></p>
      <small>â€” by <%= review.author?.username || 'Anonymous' %></small>

      <% if (currUser && review.author && review.author._id.toString() === currUser._id.toString()) { %>
        <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
          <button class="btn btn-sm btn-danger mt-1">Delete</button>
        </form>
      <% } %>
    </div>
  <% } %>
<% } %>


  <button type="submit" class="btn btn-success">Submit Review</button>
</form>

    

    <% if(listing.reviews.length){ %>

    <% } %>
  </div>

  <div class="col-8 offset-3 mb-3">
    <h3>Where you will be?</h3>
    <div id="map"></div>
  </div>
</div>

<% if (success && success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>
<% if (booked === 'success') { %>
  <div id="booking-alert" class="alert alert-success">
    Successfully booked for <%= bookedDate %>!
  </div>
<% } else if (booked === 'exists') { %>
  <div id="booking-alert" class="alert alert-warning">
    You've already booked for <%= bookedDate %>.
  </div>
<% } else if (booked === 'fail') { %>
  <div id="booking-alert" class="alert alert-danger">
    Please select a date before booking!
  </div>
<% } %>

<script>
  const alertBox = document.getElementById("booking-alert");
  if (alertBox) {
    setTimeout(() => {
      alertBox.style.display = "none";
    }, 2000); // stays visible for 2 seconds
  }
</script>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const msg = document.getElementById('booking-msg');
    if (msg) {
      setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 500);
      }, 2000);
    }
  });
</script>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="/js/map.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
  #map {
    width: 100%;
    height: 500px;
    border-radius: 8px;
  }
</style>
