<% layout("layouts/boilerplate") -%>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .book-now-hover {
    transition: transform 0.2s ease-in-out;
    font-weight: 500;
    height: 50px;
  }
  .book-now-hover:hover {
    transform: scale(1.1);
    background-color: #c82333;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  }
  .booking-alert {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-weight: bold;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease;
  }
  #map {
    width: 100%;
    height: 500px;
    border-radius: 8px;
  }
</style>

<script>
  const mapToken = "<%= process.env.MAP_TOKEN %>";
  const coordinates = <%- JSON.stringify(listing.geometry?.coordinates || [77.2090, 28.6139]) %>;
</script>

<div class="row mt-3">
  <div class="col-8 offset-2">
    <h3><%= listing.title %></h3>
  </div>

  <div class="card col-6 offset-3 show-card listing-card">
    <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
    <div class="card-body">
      <% if (listing.owner && listing.owner.username) { %>
        <p class="card-text mb-3 fw-bold" style="font-size: 1.1rem;">Owned By: <i><%= listing.owner.username %></i></p>
      <% } else { %>
        <p class="card-text text-danger mb-3">Owner unknown</p>
      <% } %>

<!-- âœ… Booking Form -->
<div class="d-flex justify-content-end mb-4">
  <form action="/listings/<%= listing._id %>/book" method="POST" class="d-flex align-items-center" style="gap: 10px;">
    <input type="date" id="bookingDate" name="date" required class="form-control form-control-sm" style="width: 160px;">
    <button type="submit" class="btn btn-danger btn-sm book-now-hover fw-bold">Book Now</button>
  </form>
</div>

<script>
  const bookedDates = <%- JSON.stringify(bookedDates || []) %>;
  const dateInput = document.getElementById("bookingDate");
  const today = new Date().toISOString().split("T")[0];
  dateInput.setAttribute("min", today);

  dateInput.addEventListener("input", () => {
    const selected = dateInput.value;
    if (bookedDates.includes(selected)) {
      Swal.fire({
        icon: 'warning',
        title: 'Date Unavailable!',
        text: 'This date is already booked. Please choose another one.',
        confirmButtonText: 'Okay'
      });
      dateInput.value = "";
    }
  });
</script>

<!-- âœ… Payment Section -->
<!-- âœ… Payment Section -->
<% if (currUser) { %>
  <% 
    // Find if the user has already paid for this listing
    const userPayment = paymentInfo; // fetched from DB in route handler
  %>

  <% if (!userPayment) { %>
    <form action="/payment/create-checkout-session/<%= listing._id %>" method="POST">
      <button type="submit" class="btn btn-success">
        Pay in Advance â‚¹<%= listing.price.toLocaleString("en-IN") %>
      </button>
    </form>
  <% } else { %>
    <button class="btn btn-success" disabled>âœ… Already Paid</button>
    <p>You paid â‚¹<%= userPayment.amount.toLocaleString("en-IN") %> on <%= new Date(userPayment.date).toDateString() %></p>
  <% } %>
<% } else { %>
  <p class="text-muted">Log in to pay and book.</p>
<% } %>


<!-- âœ… Userâ€™s Bookings (Persistent) -->
<% if (userBookedDates && userBookedDates.length > 0) { %>
  <div class="alert alert-success d-flex align-items-start mt-4 shadow-sm" role="alert">
    <span class="me-3" style="font-size: 1.5rem;">
      <i class="bi bi-calendar2-check-fill"></i>
    </span>
    <div>
      <h6 class="alert-heading mb-1">Booking Confirmed!</h6>
      <div>You booked this listing on:</div>
      <ul class="mb-0 mt-2">
        <% userBookedDates.forEach(date => { %>
          <li><%= new Date(date).toISOString().split("T")[0] %></li>
        <% }) %>
      </ul>
      <% if (paymentInfo) { %>
        <hr>
        <div>ðŸ’³ You paid â‚¹<%= paymentInfo.amount.toLocaleString("en-IN") %> on <%= new Date(paymentInfo.date).toDateString() %></div>
      <% } %>
    </div>
  </div>
<% } %>

    </div>

    <br>
    <p class="card-text"><%= listing.description %></p>
    <p class="card-text">&#8377; <%= listing.price.toLocaleString("en-IN") %></p>
    <p class="card-text"><%= listing.location %></p>
    <p class="card-text"><%= listing.country %></p>
  </div>
</div>


<!-- âœ… Sweet Alerts for New Booking -->
<% if (booked === 'success' && bookedDate && currUser) { %>
  <script>
    Swal.fire({
      icon: 'success',
      title: 'Booking Confirmed!',
      text: `ðŸŽ‰ Mr. <%= currUser.username %>, your booking on <%= bookedDate %> is confirmed.`,
      confirmButtonText: 'Awesome!',
      timer: 4000,
      timerProgressBar: true
    });
  </script>
<% } else if (booked === 'exists') { %>
  <script>
    Swal.fire({
      icon: 'warning',
      title: 'Already Booked!',
      text: 'This date has already been taken. Please select another one.',
      confirmButtonText: 'Okay'
    });
  </script>
<% } %>

<% if (bookedDate) { %>
  <div id="booking-msg" class="booking-alert">Successfully booked on <%= bookedDate %>!</div>
<% } %>

<script>
  // Fade out booking message after a few seconds
  window.addEventListener('DOMContentLoaded', () => {
    const msg = document.getElementById('booking-msg');
    if (msg) {
      setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 500);
      }, 3000);
    }
  });
</script>

<div class="btns">
  <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark col-1 offset-3 edit-btn">Edit</a>
  <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
    <button class="btn btn-dark offset-5">Delete</button>
  </form>
</div>

<!-- âœ… Reviews Section -->
<div class="col-8 offset-3 mb-3">
  <% if (currUser) { %>
    <hr/>
    <h4>Leave a Review</h4>
    <form action="/listings/<%= listing._id %>/reviews" method="POST">
      <div class="mb-3">
        <label for="rating" class="form-label">Rating</label>
        <select class="form-select" name="review[rating]" required>
          <option disabled selected>Select a rating</option>
          <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
          <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
          <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
          <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
          <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea class="form-control" name="review[comment]" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-success">Submit Review</button>
    </form>
  <% } else { %>
    <hr/>
    <p class="text-muted">Log in to leave a review.</p>
  <% } %>

  <h3 class="mt-4">Reviews</h3>
  <% if (listing.reviews.length === 0) { %>
    <p class="text-muted">No reviews yet.</p>
  <% } else { %>
    <% listing.reviews.forEach(review => { %>
      <div class="card mb-2 p-2">
        <div class="text-warning">
          <% for (let i = 0; i < review.rating; i++) { %>â˜…<% } %>
          <% for (let i = review.rating; i < 5; i++) { %>â˜†<% } %>
        </div>
        <p><%= review.comment %></p>
        <small>â€” by <%= review.author?.username || 'Anonymous' %></small>

        <% if (currUser && review.author && review.author._id.toString() === currUser._id.toString()) { %>
          <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
            <button class="btn btn-sm btn-danger mt-1">Delete</button>
          </form>
        <% } %>
      </div>
    <% }) %>
  <% } %>
</div>

<!-- âœ… Map -->
<div class="col-8 offset-3 mb-3">
  <h3>Where you will be?</h3>
  <div id="map"></div>
</div>

<% if (paymentInfo && paymentInfo.success === true) { %>
  <script>
    Swal.fire({
      title: "Payment Successful!",
      text: `â‚¹<%= paymentInfo.amount %> paid on <%= new Date(paymentInfo.date).toLocaleDateString() %>`,
      icon: "success",
      confirmButtonText: "OK"
    });
  </script>
<% } %>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const msg = document.getElementById('booking-msg');
    if (msg) {
      setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 500);
      }, 2000);
    }
  });
</script>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="/js/map.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
